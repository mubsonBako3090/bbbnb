'use client';
import { useEffect, useState } from 'react';
import { useAuth } from '@/contexts/AuthContext';
import { useRouter } from 'next/navigation';
import Header from '@/components/ui/Header';
import Footer from '@/components/Footer';
import PaymentForm from '@/components/PaymentForm';
import BillList from '@/components/BillList';
import MeterGenerator from '@/components/dashboard/MeterGenerator';
import UsageChart from '@/components/dashboard/UsageChart';
import styles from '@/styles/Dashboard.module.css';

export default function Dashboard() {
  const router = useRouter();
  const { user, isAuthenticated, loading, logout } = useAuth();

  const [dashboardData, setDashboardData] = useState(null);
  const [meterStatus, setMeterStatus] = useState(null);
  const [showMeterGenerator, setShowMeterGenerator] = useState(false);
  const [isDashboardLoading, setIsDashboardLoading] = useState(true);

  const [currentBill, setCurrentBill] = useState(null);
  const [payments, setPayments] = useState([]);
  const [showPaymentForm, setShowPaymentForm] = useState(false);

  const [meterReadings, setMeterReadings] = useState([]);
  const [currentUsage, setCurrentUsage] = useState(0);
  const [currentBillAmount, setCurrentBillAmount] = useState(0);

  // --- Fetch dashboard & meter status ---
  useEffect(() => {
    if (isAuthenticated) {
      fetchDashboardData();
      fetchMeterStatus();
    }
  }, [isAuthenticated]);

  const fetchDashboardData = async () => {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch('/api/users/dashboard', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (response.ok) {
        const data = await response.json();
        setDashboardData(data);

        // Update meter readings
        if (data.meterReadings) {
          setMeterReadings(data.meterReadings);
          const latestUsage = data.meterReadings.at(-1)?.usage || 0;
          setCurrentUsage(latestUsage);
        }

        // Compute current bill
        if (data.currentBill) {
          setCurrentBillAmount(data.currentBill.amountDue);
          setCurrentBill(data.currentBill);
        } else if (data.meterReadings?.length) {
          const latestUsage = data.meterReadings.at(-1)?.usage || 0;
          setCurrentBillAmount(latestUsage * 50); // example rate
        }
      }
    } catch (error) {
      console.error('Error fetching dashboard data:', error);
    } finally {
      setIsDashboardLoading(false);
    }
  };

  const fetchMeterStatus = async () => {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch('/api/customer/meter/generate', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (response.ok) {
        const data = await response.json();
        setMeterStatus(data);

        if (!data.hasMeter && !data.currentRequest) {
          setShowMeterGenerator(true);
        }
      }
    } catch (error) {
      console.error('Error fetching meter status:', error);
    }
  };

  const handleMeterGenerated = () => {
    setShowMeterGenerator(false);
    fetchMeterStatus();
  };

  const handleLogout = async () => {
    const result = await logout();
    if (!result.success) alert('Logout failed');
  };

  const openPaymentForm = () => {
    if (currentBill) setShowPaymentForm(true);
    else alert("No bill available.");
  };
  const closePaymentForm = () => setShowPaymentForm(false);
  const handlePay = (payment) => {
    setPayments(prev => [...prev, payment]);
    setShowPaymentForm(false);
  };

  // --- Submit new meter reading ---
  const handleSubmitReading = (newReading) => {
    setMeterReadings(prev => [...prev, newReading]);
    setCurrentUsage(newReading.usage);
    setCurrentBillAmount(newReading.usage * 50); // dynamic bill
  };

  if (loading || isDashboardLoading) {
    return (
      <>
        <Header />
        <div className={styles.loadingContainer}>
          <div className="spinner-border text-primary" role="status">
            <span className="visually-hidden">Loading...</span>
          </div>
        </div>
        <Footer />
      </>
    );
  }

  if (!isAuthenticated) {
    return (
      <>
        <Header />
        <div className={styles.unauthorized}>
          <div className="container text-center">
            <i className="bi bi-shield-exclamation"></i>
            <h2>Access Denied</h2>
            <p>Please log in to access your dashboard.</p>
          </div>
        </div>
        <Footer />
      </>
    );
  }

  return (
    <>
      <Header />
      <div className={styles.dashboard}>
        {/* Welcome */}
        <section className={styles.welcomeSection}>
          <div className="container">
            <div className="row align-items-center">
              <div className="col-md-8">
                <h1>Welcome back, {user?.firstName}!</h1>
                <p className={styles.welcomeSubtitle}>
                  Account: {user?.accountNumber} • {user?.customerType?.charAt(0).toUpperCase() + user?.customerType?.slice(1)} Customer
                  {user?.meterNumber && ` • Meter: ${user.meterNumber}`}
                </p>
              </div>
              <div className="col-md-4 text-md-end">
                <span className={styles.statusBadge}><i className="bi bi-check-circle-fill me-1"></i> Active</span>
                <button className="btn btn-danger mt-3" onClick={handleLogout}><i className="bi bi-box-arrow-right me-2"></i> Logout</button>
              </div>
            </div>
          </div>
        </section>

        {/* Meter Status Banner */}
        {meterStatus && (
          <section className={styles.sectionPadding}>
            <div className="container">
              {meterStatus.currentRequest ? (
                <div className={`${styles.statusAlert} ${styles.statusPending}`}>
                  <i className="bi bi-clock-history"></i>
                  <div className={styles.statusContent}>
                    <strong>Meter Installation Scheduled</strong>
                    <p>Your {meterStatus.meterType || 'electricity'} meter is scheduled on {new Date(meterStatus.currentRequest.estimatedInstallationDate).toLocaleDateString()}</p>
                    <small>Request ID: {meterStatus.currentRequest.requestId}</small>
                  </div>
                  <button className={styles.statusButton}>View Details</button>
                </div>
              ) : meterStatus.hasMeter ? (
                <div className={`${styles.statusAlert} ${styles.statusActive}`}>
                  <i className="bi bi-check-circle"></i>
                  <div className={styles.statusContent}>
                    <strong>Meter Active</strong>
                    <p>Your {meterStatus.meterType} meter ({meterStatus.meterNumber}) is active</p>
                    <small>Next reading: {user.nextMeterReadingDate ? new Date(user.nextMeterReadingDate).toLocaleDateString() : 'Not scheduled'}</small>
                  </div>
                  <button className={styles.statusButton}>View Readings</button>
                </div>
              ) : (
                <div className={`${styles.statusAlert} ${styles.statusIssue}`}>
                  <i className="bi bi-exclamation-triangle"></i>
                  <div className={styles.statusContent}>
                    <strong>No Meter Found</strong>
                    <p>You currently do not have an electricity meter.</p>
                    <small>Click below to request one</small>
                  </div>
                  <button className={styles.statusButton} onClick={() => setShowMeterGenerator(true)}>Request Meter</button>
                </div>
              )}
            </div>
          </section>
        )}

        {/* Show Meter Generator */}
        {showMeterGenerator && (
          <section className="section-padding">
            <div className="container">
              <MeterGenerator onComplete={handleMeterGenerated} />
            </div>
          </section>
        )}

        {/* Quick Stats */}
        {dashboardData && (
          <section className="section-padding">
            <div className="container">
              <div className="row">
                <div className="col-md-3 mb-4">
                  <div className={styles.statCard}>
                    <div className={styles.statIcon}><i className="bi bi-receipt"></i></div>
                    <div className={styles.statContent}>
                      <h3>₦{currentBillAmount}</h3>
                      <p>Current Bill</p>
                      <small>Due {new Date(currentBill?.dueDate || Date.now()).toLocaleDateString()}</small>
                    </div>
                  </div>
                </div>
                <div className="col-md-3 mb-4">
                  <div className={styles.statCard}>
                    <div className={styles.statIcon}><i className="bi bi-lightning"></i></div>
                    <div className={styles.statContent}>
                      <h3>{currentUsage} kWh</h3>
                      <p>Last Month Usage</p>
                      <small>Usage Trend Available</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        )}

        {/* Usage Chart */}
        {meterReadings?.length > 0 && (
          <section className={styles.sectionPadding}>
            <div className="container">
              <h3>Energy Usage</h3>
              <UsageChart readings={meterReadings} />
            </div>
          </section>
        )}

        {/* Payment Section */}
        <section className="section-padding">
          <div className="container">
            <h2 className="section-title mb-4">Make a Payment</h2>
            <button className="btn btn-primary mb-3" onClick={openPaymentForm}><i className="bi bi-credit-card me-2"></i> Pay Now</button>
            {showPaymentForm && currentBill && <PaymentForm bill={currentBill} onClose={closePaymentForm} onSubmit={handlePay} />}
            <BillList bills={payments} />
          </div>
        </section>

        {/* Meter Readings & Actions */}
        {user?.meterNumber && (
          <section className="section-padding">
            <div className="container">
              <h3>Your Meter</h3>
              <p>Meter Number: {user.meterNumber}</p>
              <p>Meter Type: {user.meterType}</p>
              <button className="btn btn-secondary me-2" onClick={() => handleSubmitReading({ usage: currentUsage + 10, date: new Date() })}>Submit Reading</button>
              <button className="btn btn-secondary me-2">View History</button>
            </div>
          </section>
        )}

      </div>
      <Footer />
    </>
  );
}
